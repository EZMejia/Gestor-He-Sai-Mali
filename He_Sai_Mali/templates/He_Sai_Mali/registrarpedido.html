{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'He_Sai_Mali/logo.png' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if pedido_existente %}Añadir Platillos a Pedido N°{{ pedido_existente.idPedido }}{% else %}Registrar Nuevo Pedido{% endif %}</title>
    <style>
        body {
            background-color: #2c3038;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            box-sizing: border-box;
            margin: 0;
            background-color: #981a28;
            border-bottom: 8px solid #f3bb67;
            
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
            padding: 0 2%;
            box-shadow: 0 6px 10px black;

            position: relative;

            user-select: none;
            z-index: 1000;
        }

        header img {
            height: 40px;
            margin-right: 10px;
        }

        header .Titulo {
            display: flex;
            align-items: center;
            text-align: left;
            color:#dacfb7;
            font-size: 25px;
            margin-right: auto;
        }
        header .Info {
            display: flex;
            align-items: center;
            text-align: left;
            color:#dacfb7;
            font-size: 15px;
            margin-right: 0;
            background-color: #b12131;
            border-radius: 5px;
            padding: 10px;
        }

        .dropdown-rol {
            display: inline-block;
            padding: 0;
            margin:     0;
            list-style-type: none;
            color:#ffffff;
            background-color: #981a28;
        }

        .dropdown-btn {
            text-decoration: none;
            color: inherit;
            display: flex;
            justify-content: center;
            min-width: 130px;
            padding: 42px 10px;
            margin: 0;
            background-color: #981a28;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: normal;
            transition: all 0.2s ease;
        }

        .dropdown-btn:hover {
            background-color: #b12131;
            color: #dacfb7;
            box-shadow: inset 0 -4px 0px #f3bb67;
        }

        .dropdown-content {
            position: absolute;
            background-color: #981a28;
            min-width: 130px;
            box-shadow: 0px 8px 16px 3px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0 0 5px 5px;
            margin: 0;
            border-top: 8px solid #f3bb67;

            overflow: hidden;
            max-height: 0;
            opacity: 0;
            
            transition: max-height 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        
        .show {
            max-height: 500px;
            opacity: 1;
            
            display: block; 
        }

        .option-link {
            color: white;
            padding: 10px 16px;
            text-decoration: none; 
            display: block; 
            transition: background-color 0.2s;
            font-size: 15px;
            border-radius: 5px;
        }

        .option-link:hover {
            background-color: #b12131;
            border-bottom: 2px solid #f3bb67;
        }

        .show {
            display: block;
        }

        /*------------------------------*/
        .salir {
            display: flex;
            padding: 0;
            margin: 0 15px 0 0;
            list-style-type: none;
            color:#ffffff;
            background-color: #981a28;
        }
        .btn-salir {
            text-decoration: none;
            color: inherit;
            display: flex;
            justify-content: center;
            min-width: 100px;
            padding: 32px 10px;
            margin: 0;
            background-color: #981a28;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-salir h1 {
            font-size: 15px;
            font-weight: normal;
        }
        .btn-salir:hover {
            background-color: #b12131;
            color: #dacfb7;
            box-shadow: inset 0 -4px 0px #f3bb67;
        }
        .btn-salir:active {
            background-color: #f3bb67;
            color: #981a28;
        }

        /*-- Contenido de Registro (Estilos Nuevos/Adaptados) --*/

        .contenido {
            width: 90%;
            margin: 10px auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 50px 10px rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        .Titulo-Registro {
            color: #981a28;
            border-bottom: 3px solid #f3bb67;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .section-header {
            background-color: #dacfb7; 
            color: #981a28;
            padding: 10px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            font-size: 1.2em;
        }
        .card-body {
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .table thead tr {
            background-color: #b12131;
            color: white;
        }
        .table th, .table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .form-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .form-control, .form-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-text {
            font-size: 0.85em;
            color: #666;
            margin-top: -5px;
            margin-bottom: 10px;
        }
        
        /* Botones de Acción Globales */
        .action-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-success-lg { 
            background-color: #4CAF50; 
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .btn-success-lg:hover { background-color: #38761d; }

        .btn-secondary-lg {
            background-color: #6c757d; 
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .btn-secondary-lg:hover { background-color: #5a6268; }

        .badge-info {
            background-color: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .alert-error { 
            background-color: #f44336; 
            color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .alert-success { 
            background-color: #4CAF50; 
            color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        footer {
            display: flex;
            color: #dacfb7;
            background-color: #41444a;
            justify-content: center;
            align-items: center;
            border-bottom: 10px solid #2c3038;
            font-size: 14px;
            margin-top: 20px; /* Asegura separación del contenido */
        }
    </style>
</head>
<body>
    <header>
        <img src="{% static 'He_Sai_Mali/logo.png' %}" alt="Logo He Sai Mali">
        <h1 class="Titulo">
            {% if pedido_existente %}
                AÑADIR PLATILLOS
            {% else %}
                REGISTRAR PEDIDO
            {% endif %}
        </h1>
        
        {% if rol_empleado == "Administrador"%}
            <div class="dropdown-rol">
                <button class="dropdown-btn" onclick="toggleDropdown()">VISTAS</button>

                <div id="rolMenu" class="dropdown-content">
                    <a href="{% url 'pedidos' %}" class="option-link">Pedidos</a>
                    <a href="{% url 'cocina' %}" class="option-link">Cocina</a>
                    <a href="{% url 'admin_ingredientes' %}" class="option-link">Ingredientes</a>
                    <a href="{% url 'admin_platillos' %}" class="option-link">Platillos</a>
                    <a href="{% url 'admin_proveedores' %}" class="option-link">Proveedores</a>
                    <a href="{% url 'registro' %}" class="option-link">Registrar User</a>
                </div>
            </div>
        {% endif %}

        <form method="POST" action="{% url 'logout' %}" class="salir">
            {% csrf_token %}
            <button type="submit" class="btn-salir">
                <h1>CERRAR SESIÓN</h1>
            </button>
        </form>

        <h1 class="Info">{{ nombre_empleado }} {{ apellido_empleado }} ({{ rol_empleado }})</h1>
    </header>
    
    <div class="contenido">
        {% if error_message %}
            <div class="alert-error">
                **Error:** {{ error_message }}
            </div>
        {% endif %}
        
        {% if messages %}
            {% for message in messages %}
                <div class="{% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-warning{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <h1 class="Titulo-Registro">
            {% if pedido_existente %}
                Añadir Platillos a Pedido N°{{ pedido_existente.idPedido }}
                <p style="font-size: 1em; color: #555; margin-top: 5px;">
                    Cliente: {{ pedido_existente.idCliente.nombre }} | Telefono: {{ pedido_existente.idCliente.telefono }} | Mesa: {% if pedido_existente.idMesa %}{{ pedido_existente.idMesa.idMesa }}{% else %}Ninguna{% endif %}
                </p>
            {% else %}
                Registrar Nuevo Pedido
            {% endif %}
        </h1>

        <form method="post">
            {% csrf_token %}

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <h3 style="color: #981a28; border-bottom: 1px solid #ccc;">Datos del Cliente</h3>
                    {% if pedido_existente %}
                        <p style="color: #666;">Cliente y mesa no se pueden cambiar en pedidos existentes.</p>
                        <input type="hidden" name="nombre_cliente" value="{{ pedido_existente.idCliente.nombre }}" autocomplete="off">
                        <input type="hidden" name="telefono_cliente" value="{{ pedido_existente.idCliente.telefono }}" autocomplete="off">
                        <input type="hidden" name="tipo_cliente" value="a"> {% else %}
                        <div>
                            <label for="nombre_cliente" class="form-label">Nombre del Cliente *</label>
                            <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" required value="{{ nombre_cliente_previo }}">
                        </div>
                        
                        <div>
                            <label for="tipo_cliente" class="form-label">Tipo de Cliente *</label>
                            <select name="tipo_cliente" id="tipo_cliente" class="form-select" onchange="toggleIdentificacion()">
                                <option value="persona" selected>Persona</option>
                                <option value="empresa">Empresa</option>
                            </select>
                        </div>
                        
                        <div id="identificacion_field" style="display: none;">
                            <label for="identificacion_cliente" class="form-label">Identificación (RUC) *</label>
                            <input type="text" class="form-control" id="identificacion_cliente" name="identificacion_cliente" autocomplete="off">
                        </div>
                        
                        <div>
                            <label for="telefono_cliente" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="telefono_cliente" name="telefono_cliente" value="{{ telefono_cliente_previo }}" autocomplete="off">
                        </div>
                        <div>
                            <label for="correo_cliente" class="form-label">Correo</label>
                            <input type="email" class="form-control" id="correo_cliente" name="correo_cliente" autocomplete="off">
                        </div>
                    {% endif %}
                </div>

                <div style="flex: 1;">
                    {% if not pedido_existente %}
                        <h3 style="color: #981a28; border-bottom: 1px solid #ccc;">Asignación de Mesa</h3>
                        <div>
                            <label for="mesa" class="form-label">Número de Mesa:</label>
                            <select name="mesa" id="mesa" class="form-select">
                                <option value="ninguna" selected>Ninguna Mesa (Pedido Externo)</option>
                                
                                {% for mesa in mesas_disponibles %}
                                    <option value="{{ mesa.idMesa }}">Mesa {{ mesa.idMesa }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Solo se muestran las mesas que no están ocupadas.</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div>
                <div class="section-header">
                    Selección de Platillos
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Platillo</th>
                                <th>Precio</th>
                                <th style="width: 150px; text-align: center;">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for platillo in platillos %}
                                <tr>
                                    <td>{{ platillo.nombre }}</td>
                                    <td><span class="badge-info">C$ {{ platillo.precio|floatformat:2 }}</span></td>
                                    <td>
                                        <input type="number" 
                                                name="cantidad_{{ platillo.idProductoMenu }}" 
                                                min="0" 
                                                value="0" 
                                                class="form-control"
                                                style="text-align: center;"
                                                onchange="if(this.value < 0) this.value = 0;">
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="action-group">
                <a href="{% url 'pedidos' %}" class="btn-secondary-lg">Cancelar y Volver</a>
                <button type="submit" class="btn-success-lg">
                    {% if pedido_existente %}
                        Añadir Platillos a Pedido
                    {% else %}
                        Guardar Pedido y Enviar a Cocina
                    {% endif %}
                </button>
            </div>
        </form>
    </div>
    
    <footer>
        <p>2025 Hê Sãî Mãlî.</p>
    </footer>
    
    <script>
        function toggleDropdown() {
            document.getElementById("rolMenu").classList.toggle("show");
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function toggleIdentificacion() {
            var tipoCliente = document.getElementById('tipo_cliente').value;
            var identificacionField = document.getElementById('identificacion_field');
            var identificacionInput = document.getElementById('identificacion_cliente');
            
            if (tipoCliente === 'empresa') {
                identificacionField.style.display = 'block';
                identificacionInput.setAttribute('required', 'required');
            } else {
                identificacionField.style.display = 'none';
                identificacionInput.removeAttribute('required');
                identificacionInput.value = ''; // limpiar el valor si se oculta
            }
        }
        
        document.addEventListener('DOMContentLoaded', toggleIdentificacion);
    </script>
</body>
</html>