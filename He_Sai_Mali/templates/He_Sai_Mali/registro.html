{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'He_Sai_Mali/logo.png' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>He Sai Mali - Registro</title>
    <style>
        body { 
            font-family: 'Roboto', sans-serif;
            background-image: url("{% static 'He_Sai_Mali/fondo.png' %}");
            background-position: center bottom;
            display: flex;
            justify-content: center; /* Centrar el contenido */
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
        }

        form {
            display: block;
            margin: 100px auto;
            padding: 40px; 
            background-color: white;
            box-shadow: 0 0 50px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
        }

        h2 {
            margin-top: 10px;
        }
        
        .He_Sai_Mali {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .He_Sai_Mali .logo-texto{
            display: flex;
            align-items: center;
        }

        .He_Sai_Mali .logo{
            height: 40px;
            margin-right: 3px;
        }

        .He_Sai_Mali h2{
            margin: 0;
            padding: 0;
            font-size:large;
            color: #981a28;
        }

        .flechaRegresar {
            width: 25px;
            height: 25px;
            transform: rotate(180deg);
            filter: 
                brightness(0) 
                saturate(100%) 
                invert(13%) 
                sepia(97%) 
                saturate(700%) 
                hue-rotate(320deg) 
                brightness(130%) 
                contrast(100%);
        }

        .flechaRegresar:hover {
            filter: 
                brightness(0) 
                saturate(100%) 
                invert(13%) 
                sepia(97%) 
                saturate(700%) 
                hue-rotate(320deg) 
                brightness(90%) 
                contrast(100%);
        }

        .flechaRegresar:active {
            filter: 
                brightness(0) 
                saturate(100%) 
                invert(13%) 
                sepia(97%) 
                saturate(700%) 
                hue-rotate(320deg) 
                brightness(170%) 
                contrast(100%);
        }

        input, select { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0;
            border-width: 0 0 2px 0; 
            border-style: solid;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }
        
        /* Nuevo estilo para resaltar los inputs con error */
        input.error-highlight, select.error-highlight {
            border-bottom-color: red !important;
        }

        /* Estilos de error */
        .error { color: red; }
        .success { color: green; }

        /* Estilo para el contenedor de errores internos */
        #form-error-message {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid red;
            background-color: #ffeaea;
            color: red;
            border-radius: 4px;
            display: none; /* Oculto por defecto */
        }
        
        .step-section {
            display: none;
            margin: 10px;
        }
        #step-1 {
            display: block;
        }
        .botones {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }

        .Continuar {
            padding: 5px 20px;
            gap: 5px;
            background-color: #981a28;
            color: white;
            border: 2px solid #f3bb67;
            border-radius: 5px;
            user-select: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .Continuar:hover {
            background-color: #832630;
        }
        
        .Continuar:active {
            background-color: #b52435;
            transform: scale(97%);
        }

        .Registrarse {
            padding: 5px 20px;
            background-color: black;
            color: white;
            border: 2px solid #f3bb67;
            border-radius: 5px;
            user-select: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .Registrarse:hover {
            background-color: #981a28;
        }

        .Registrarse:active {
            background-color: black;
            transform: scale(97%);
        }
    </style>
</head>
<body>
    <form id="registrationForm" method="post">
        <div class="He_Sai_Mali">
            <a href="{% url 'pedidos' %}">
                <img href="{% url 'pedidos' %}" src="{% static 'He_Sai_Mali/flecha.png' %}" class="flechaRegresar" alt="regresar">
            </a>

            <div class="logo-texto">
                <img src="{% static 'He_Sai_Mali/logo.png' %}" class="logo" alt="Logo He Sai Mali">
                <h2>He Sai Mali</h2>
            </div>
        </div>

        <h2>Registro de Empleado</h2>
        {% csrf_token %}
        
        <div id="form-error-message"></div>

        <div class="step-section" id="step-1">
            <h3>Paso 1: Datos Personales</h3>
            <p>
                <label>Nombre:</label>
                <input type="text" name="nombre" id="nombre" value="{{ valores.nombre }}" placeholder="Nombre" required autocomplete="off">
            </p>
            <p>
                <label>Apellido:</label>
                <input type="text" name="apellido" id="apellido" value="{{ valores.apellido }}" placeholder="Apellido" required autocomplete="off">
            </p>
            <p>
                <label>Rol:</label>
                <select name="rol" id="rol" required>
                    <option value="">Seleccionar rol</option>
                    <option value="Administrador" {% if valores.rol == 'Administrador' %}selected{% endif %}>Administrador</option>
                    <option value="Mesero" {% if valores.rol == 'Mesero' %}selected{% endif %}>Mesero</option>
                    <option value="Cocinero" {% if valores.rol == 'Cocinero' %}selected{% endif %}>Cocinero</option>
                </select>
            </p>
            <div class="botones">
                <button type="button" onclick="nextStep(1)" class="Continuar">Siguiente</button>
            </div>
        </div>

        <div class="step-section" id="step-2">
            <h3>Paso 2: Contacto e Identificación</h3>
            <p>
                <label>Correo:</label>
                <input type="email" name="correo" id="correo" value="{{ valores.correo }}" placeholder="nombre@dominio.com" required autocomplete="off">
            </p>
            <p>
                <label>Teléfono:</label>
                <input type="text" name="telefono" id="telefono" value="{{ valores.telefono }}" placeholder="00000000" required autocomplete="off">
            </p>
            <p>
                <label>Cédula:</label>
                <input type="text" name="cedula" id="cedula" value="{{ valores.cedula }}" placeholder="000-000000-0000X" required autocomplete="off">
            </p>
            <div class="botones">
                <button type="button" onclick="prevStep(2)" class="Continuar">Atrás</button>
                <button type="button" onclick="nextStep(2)" class="Continuar">Siguiente</button>
            </div>
        </div>

        <div class="step-section" id="step-3">
            <h3>Paso 3: Credenciales de Acceso</h3>
            <p>
                <label>Contraseña:</label>
                <input type="password" name="contrasena1" id="contrasena1" placeholder="••••••••" required autocomplete="off">
            </p>
            <p>
                <label>Confirmar contraseña:</label>
                <input type="password" name="contrasena2" id="contrasena2" placeholder="••••••••" required autocomplete="off">
            </p>
            <div class="botones">
                <button type="button" onclick="prevStep(3)" class="Continuar">Atrás</button>
                <button type="button" onclick="nextStep(3)" class="Continuar">Siguiente</button>
            </div>
        </div>

        <div class="step-section" id="step-4">
            <h3>Paso 4: Resumen</h3>
            <p>
                <label class="summary-label">Usuario:</label>
                <span id="summary-usuario"></span>
            </p>
            <p>
                <label class="summary-label">Nombre Completo:</label>
                <span id="summary-nombre"></span>
            </p>
            <p>
                <label class="summary-label">Rol:</label>
                <span id="summary-rol"></span>
            </p>
            <p>
                <label class="summary-label">Correo:</label>
                <span id="summary-correo"></span>
            </p>
            <p>
                <label class="summary-label">Cédula:</label>
                <span id="summary-cedula"></span>
            </p>

            <div class="botones">
                <button type="button" onclick="prevStep(4)" class="Continuar">Atrás</button>
                <button type="submit" class="Registrarse">Registrarse</button>
            </div>
        </div>
    </form>

    <script>
        // ----------------------------------------------------------------------------------
        // 1. OBTENCIÓN DE DATOS EXISTENTES DESDE DJANGO
        // ----------------------------------------------------------------------------------
        const existingEmails = {{ correos_existentes|safe|default:"[]" }};
        const existingPhones = {{ telefonos_existentes|safe|default:"[]" }};
        const existingCedulas = {{ cedulas_existentes|safe|default:"[]" }};
        const existingUsernames = {{ usuarios_existentes|safe|default:"[]" }}; // NUEVA VARIABLE

        // Función para mostrar el paso actual y ocultar los demás
        function showStep(stepNumber) {
            // Ocultar el mensaje de error al cambiar de paso
            document.getElementById('form-error-message').style.display = 'none';
            
            document.querySelectorAll('.step-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`step-${stepNumber}`).style.display = 'block';
        }

        // Función para mostrar el error (corregida para usar innerHTML)
        function displayError(message) {
            const errorDiv = document.getElementById('form-error-message');
            errorDiv.innerHTML = message; // Se usa innerHTML para renderizar los <br> y permitir mensajes multilínea
            errorDiv.style.display = 'block';
        }

        // ----------------------------------------------------------------------------------
        // LÓGICA DE GENERACIÓN DE NOMBRE DE USUARIO (MODIFICADA)
        // ----------------------------------------------------------------------------------
        // 1. Genera el nombre de usuario base (ej: juanadmHSM)
        function generateBaseUsername(nombre, apellido, rol) {
            const n = nombre.trim().substring(0, 2).toLowerCase();
            const a = apellido.trim().substring(0, 2).toLowerCase();
            const r = rol.trim(); 
            return n + a + r + "HSM";
        }

        // 2. Itera y agrega un sufijo numérico si el nombre de usuario ya existe
        function generateUniqueUsername(nombre, apellido, rol, existingUsernames) {
            const baseUser = generateBaseUsername(nombre, apellido, rol);
            let potentialUsername = baseUser;
            let counter = 1;

            // El primer nombre de usuario (sin número) debe chequearse primero.
            while (existingUsernames.includes(potentialUsername)) {
                // Si existe, añade el contador y lo prueba de nuevo en la siguiente iteración
                potentialUsername = baseUser + counter;
                counter++;
            }
            
            return potentialUsername;
        }

        // ----------------------------------------------------------------------------------
        // LÓGICA DE PASOS
        // ----------------------------------------------------------------------------------

        // Función para ir al siguiente paso, con validación mejorada
        function nextStep(currentStep) {
            const currentSection = document.getElementById(`step-${currentStep}`);
            const requiredInputs = currentSection.querySelectorAll('[required]');
            
            // Limpiar errores previos
            document.getElementById('form-error-message').style.display = 'none';
            document.querySelectorAll('.error-highlight').forEach(el => {
                el.classList.remove('error-highlight');
            });
            
            let isValid = true;
            let firstInvalidInput = null;
            let errorMessage = "Por favor, completa todos los campos requeridos para continuar.";

            // --- 1. Validar campos vacíos y recopilar el primer campo inválido ---
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error-highlight');
                    if (!firstInvalidInput) {
                        firstInvalidInput = input;
                    }
                } else {
                    input.classList.remove('error-highlight');
                }
            });

            // Si hay campos vacíos, no continuar con validaciones de formato
            if (isValid) {
            
                // --- 2. Validaciones de formato y UNICIDAD por Paso ---
                if (currentStep === 1) {
                    const nombre = document.getElementById('nombre').value;
                    const apellido = document.getElementById('apellido').value;
                    const rol = document.getElementById('rol').value; // Usar el valor para la validación
                    // Expresión regular para letras (a-z, A-Z), letras acentuadas, ñ, Ñ y espacios
                    const nameRegex = /^[a-zA-Z\u00C0-\u017F\sñÑ]*$/; 

                    if (!rol) {
                        isValid = false;
                        errorMessage = "Debes seleccionar un Rol para continuar.";
                        document.getElementById('rol').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('rol');
                    } else if (!nameRegex.test(nombre)) {
                        isValid = false;
                        errorMessage = "El nombre solo puede contener letras y espacios.";
                        document.getElementById('nombre').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('nombre');
                    } else if (!nameRegex.test(apellido)) {
                        isValid = false;
                        errorMessage = "El apellido solo puede contener letras y espacios.";
                        document.getElementById('apellido').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('apellido');
                    }
                } else if (currentStep === 2) {
                    const correo = document.getElementById('correo').value.trim();
                    const telefono = document.getElementById('telefono').value.trim();
                    const cedula = document.getElementById('cedula').value.trim();
                    
                    // Convertir el teléfono a número para asegurar la comparación de tipo
                    const telefonoNum = Number(telefono); 
                    
                    // RegEx para formato de correo electrónico estándar
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
                    // RegEx para solo 8 dígitos
                    const phoneRegex = /^\d{8}$/; 
                    // RegEx para el formato 000-000000-0000X
                    const cedulaRegex = /^\d{3}-\d{6}-\d{4}[A-Z]$/; 

                    if (!emailRegex.test(correo)) {
                        isValid = false;
                        errorMessage = "El formato de Correo Electrónico debe ser nombre@dominio.com.";
                        document.getElementById('correo').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('correo');
                    } else if (telefono && !phoneRegex.test(telefono)) {
                        isValid = false;
                        errorMessage = "El teléfono debe ser de 8 dígitos numéricos.";
                        document.getElementById('telefono').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('telefono');
                    } else if (!cedulaRegex.test(cedula)) {
                        isValid = false;
                        errorMessage = "El formato de Cédula debe ser 000-000000-0000X.";
                        document.getElementById('cedula').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('cedula');
                    } 
                    
                    // VALIDACIÓN DE UNICIDAD (Existencia en BD)
                    else if (existingEmails.includes(correo)) {
                        isValid = false;
                        errorMessage = "El correo ya está registrado por otro empleado. Por favor, verifica el dato.";
                        document.getElementById('correo').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('correo');
                    } else if (existingPhones.includes(telefonoNum)) { 
                        isValid = false;
                        errorMessage = "El número de teléfono ya está registrado por otro empleado. Por favor, verifica el dato.";
                        document.getElementById('telefono').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('telefono');
                    } else if (existingCedulas.includes(cedula)) {
                        isValid = false;
                        errorMessage = "La cédula ya está registrada por otro empleado. Por favor, verifica el dato.";
                        document.getElementById('cedula').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('cedula');
                    }
                } else if (currentStep === 3) {
                    const pass1 = document.getElementById('contrasena1').value;
                    const pass2 = document.getElementById('contrasena2').value;
                    
                    // RegEx para contraseña fuerte: Mínimo 8 caracteres, al menos 1 mayúscula, 1 minúscula y 1 número
                    const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;

                    if (pass1 !== pass2) {
                        isValid = false;
                        errorMessage = "Las contraseñas no coinciden. Por favor, verifícalas.";
                        document.getElementById('contrasena1').classList.add('error-highlight');
                        document.getElementById('contrasena2').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('contrasena1');
                    } else if (!strongPasswordRegex.test(pass1)) {
                        isValid = false;
                        errorMessage = "La contraseña debe tener al menos 8 caracteres, incluyendo una mayúscula, una minúscula y un número.";
                        document.getElementById('contrasena1').classList.add('error-highlight');
                        document.getElementById('contrasena2').classList.add('error-highlight');
                        if (!firstInvalidInput) firstInvalidInput = document.getElementById('contrasena1');
                    }
                }
            }


            // --- 3. Manejo del flujo (Si es válido o no) ---
            if (isValid) {
                const nextStepNumber = currentStep + 1;

                if (nextStepNumber === 4) {
                    updateSummary();
                }
                
                showStep(nextStepNumber);
            } else {
                // Mostrar el error en el div
                displayError(errorMessage);

                if (firstInvalidInput) {
                    firstInvalidInput.focus();
                }
            }
        }

        // Función para regresar al paso anterior
        function prevStep(currentStep) {
            showStep(currentStep - 1);
        }

        // Función para actualizar el resumen y generar el usuario
        function updateSummary() {
            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            const rolSelect = document.getElementById('rol');
            const rol = rolSelect.options[rolSelect.selectedIndex].text;
            const correo = document.getElementById('correo').value;
            const cedula = document.getElementById('cedula').value;

            // 1. Generar y mostrar el USUARIO (USA LA NUEVA LÓGICA DE UNICIDAD)
            const usuario = generateUniqueUsername(nombre, apellido, rol, existingUsernames);
            document.getElementById('summary-usuario').textContent = usuario;

            // 2. Mostrar la demás información en el resumen
            document.getElementById('summary-nombre').textContent = `${nombre} ${apellido}`;
            document.getElementById('summary-rol').textContent = rol;
            document.getElementById('summary-correo').textContent = correo;
            document.getElementById('summary-cedula').textContent = cedula;

            // 3. Crear campo oculto para enviar el usuario
            let user_input = document.getElementById('generated_username');
            if (!user_input) {
                user_input = document.createElement('input');
                user_input.type = 'hidden';
                user_input.name = 'usuario';
                user_input.id = 'generated_username';
                document.getElementById('registrationForm').appendChild(user_input);
            }
            user_input.value = usuario;
        }

        // Asegurarse de que solo el primer paso se muestre al cargar
        document.addEventListener('DOMContentLoaded', () => {
            showStep(1);
        });
    </script>
</body>
</html>